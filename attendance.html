<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ប្រព័ន្ធគ្រប់គ្រងវត្តមានសិស្ស</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@300;400;700&family=Moul&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kantumruy Pro', sans-serif; }
        .khmer-moul { font-family: 'Moul', serif; }
        .pdf-text-11 { font-size: 11pt; line-height: 1.5; }
        .signature-grid { display: grid; grid-template-columns: 1fr 1fr; width: 100%; margin-top: 10px; }
        .sig-col { text-align: center; }
        .student-photo-box { width: 50px; height: 60px; border: 1px solid #ddd; object-fit: cover; border-radius: 4px; }
        @media print { .no-print { display: none; } }
        .pdf-header-item:empty { display: none; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app" class="min-h-screen flex flex-col">
        <!-- Nav -->
        <nav class="bg-indigo-900 text-white shadow-xl no-print">
            <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <div class="bg-white p-2 rounded-lg text-indigo-900 shadow-inner">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    </div>
                    <span class="khmer-moul text-xl tracking-wider">ប្រព័ន្ធគ្រប់គ្រងវត្តមាន</span>
                </div>
                <div class="flex space-x-6 text-sm">
                    <button onclick="switchTab('attendance')" class="hover:text-yellow-400 transition">កត់វត្តមាន</button>
                    <button onclick="switchTab('students')" class="hover:text-yellow-400 transition">គ្រប់គ្រងសិស្ស</button>
                    <button onclick="switchTab('reports')" class="hover:text-yellow-400 transition">របាយការណ៍</button>
                </div>
            </div>
        </nav>

        <main class="flex-grow max-w-7xl mx-auto w-full p-6">
            
            <!-- Attendance Tab -->
            <div id="tab-attendance" class="tab-content">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 mb-6">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                        <h2 class="khmer-moul text-xl text-indigo-900">កត់ត្រាវត្តមានប្រចាំថ្ងៃ</h2>
                        <div class="flex flex-wrap gap-3">
                            <input type="date" id="attendance-date" class="border border-gray-300 p-2 rounded-lg shadow-sm" onchange="loadAttendanceList()">
                            <select id="select-class-attendance" class="border border-gray-300 p-2 rounded-lg shadow-sm" onchange="loadAttendanceList()">
                                <option value="">ជ្រើសរើសថ្នាក់</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-indigo-50 text-indigo-900 border-b">
                            <tr>
                                <th class="p-4 text-center">ល.រ</th>
                                <th class="p-4">រូបថត</th>
                                <th class="p-4">ឈ្មោះសិស្ស</th>
                                <th class="p-4 text-center">ស្ថានភាព</th>
                                <th class="p-4">ចំណាំ</th>
                            </tr>
                        </thead>
                        <tbody id="attendance-list">
                            <tr><td colspan="5" class="p-10 text-center text-gray-400 italic">សូមជ្រើសរើសថ្នាក់ដើម្បីកត់វត្តមាន</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="mt-6 flex justify-end no-print">
                    <button onclick="saveAttendance()" class="bg-green-600 text-white px-10 py-3 rounded-xl hover:bg-green-700 font-bold shadow-lg transition transform hover:-translate-y-1">រក្សាទុកវត្តមាន</button>
                </div>
            </div>

            <!-- Student Tab -->
            <div id="tab-students" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="khmer-moul text-xl text-indigo-900">គ្រប់គ្រងសិស្ស</h2>
                    <div class="flex gap-3">
                        <button onclick="openModal('class-modal')" class="bg-white text-indigo-700 px-5 py-2.5 rounded-xl border border-indigo-200 shadow-sm hover:bg-indigo-50 transition">
                            + បង្កើតថ្នាក់
                        </button>
                        <button onclick="openModal('student-modal')" class="bg-indigo-600 text-white px-5 py-2.5 rounded-xl shadow-md hover:bg-indigo-700 transition">
                            + បន្ថែមសិស្ស
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200">
                        <h3 class="font-bold border-b pb-3 mb-4 text-indigo-900">បញ្ជីថ្នាក់រៀន</h3>
                        <ul id="class-list-sidebar" class="space-y-1"></ul>
                    </div>
                    <div class="md:col-span-3 bg-white rounded-2xl shadow-sm border border-gray-200 overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50 border-b text-gray-600">
                                <tr>
                                    <th class="p-4 text-left">អត្តលេខ</th>
                                    <th class="p-4 text-left">រូបថត</th>
                                    <th class="p-4 text-left">ឈ្មោះសិស្ស</th>
                                    <th class="p-4">អាណាព្យាបាល / លេខទូរស័ព្ទ</th>
                                    <th class="p-4 text-center">ភេទ</th>
                                    <th class="p-4 text-right">សកម្មភាព</th>
                                </tr>
                            </thead>
                            <tbody id="student-list-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="tab-reports" class="tab-content hidden">
                <div class="flex flex-wrap justify-between items-center mb-6 no-print gap-4">
                    <div class="flex gap-2">
                        <select id="report-type" class="border p-2 rounded-lg text-sm bg-white" onchange="updateReportData()">
                            <option value="ថ្ងៃ">របាយការណ៍ប្រចាំថ្ងៃ</option>
                            <option value="សប្ដាហ៍">របាយការណ៍ប្រចាំសប្ដាហ៍</option>
                            <option value="ខែ" selected>របាយការណ៍ប្រចាំខែ</option>
                            <option value="ត្រីមាស">របាយការណ៍ប្រចាំត្រីមាស</option>
                            <option value="ឆមាស">របាយការណ៍ប្រចាំឆមាស</option>
                        </select>
                    </div>
                    <button onclick="generatePDF()" class="bg-red-600 text-white px-6 py-2 rounded-xl flex items-center gap-2 hover:bg-red-700 transition shadow-lg">
                        ទាញយក PDF
                    </button>
                </div>

                <div id="pdf-content" class="bg-white p-12 shadow-2xl max-w-4xl mx-auto text-black leading-relaxed" style="min-height: 29.7cm;">
                    <div class="text-center mb-1">
                        <h1 class="khmer-moul text-xl">ព្រះរាជាណាចក្រកម្ពុជា</h1>
                        <h2 class="khmer-moul text-lg">ជាតិ សាសនា ព្រះមហាក្សត្រ</h2>
                        <div class="flex justify-center my-1">
                            <img src="https://lh3.googleusercontent.com/u/0/d/1BnGzoisjHxGRiMbsrP-rZ1F9zvSfdtAh" alt="National Symbol" class="h-5 object-contain" crossorigin="anonymous">
                        </div>
                    </div>

                    <div class="flex flex-col items-start mb-4 text-sm font-bold">
                        <span id="pdf-org-unit" class="pdf-text-11 pdf-header-item"></span>
                        <span id="pdf-school-name" class="pdf-text-11 pdf-header-item"></span>
                        <span id="pdf-class-name" class="pdf-text-11 pdf-header-item"></span>
                    </div>

                    <div class="text-center mb-6">
                        <h3 id="pdf-report-title" class="khmer-moul text-lg underline decoration-double">របាយការណ៍វត្តមានសិស្សប្រចាំខែ</h3>
                    </div>

                    <table class="w-full border-collapse border border-black text-[10pt] mb-6">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="border border-black p-1">ល.រ</th>
                                <th class="border border-black p-1">អត្តលេខ</th>
                                <th class="border border-black p-1">គោត្តនាម-នាម</th>
                                <th class="border border-black p-1">ភេទ</th>
                                <th class="border border-black p-1">មក</th>
                                <th class="border border-black p-1">ច្បាប់</th>
                                <th class="border border-black p-1">អវត្តមាន</th>
                                <th class="border border-black p-1">ភាគរយ %</th>
                            </tr>
                        </thead>
                        <tbody id="pdf-report-body"></tbody>
                    </table>

                    <div class="w-full flex flex-col items-end">
                        <div class="text-center">
                            <p id="pdf-lunar-date" class="pdf-text-11">ថ្ងៃព្រហស្បតិ៍ ១១កើត ខែមាឃ ឆ្នាំម្សាញ់ សប្ដស័ក ព.ស ២៥៦៩</p>
                            <p id="pdf-solar-date" class="pdf-text-11">រាជធានីភ្នំពេញ ថ្ងៃទី២៩ ខែមករា ឆ្នាំ២០២៦</p>
                        </div>
                    </div>

                    <div class="signature-grid">
                        <div class="sig-col">
                            <p class="pdf-text-11">បានឃើញ និងឯកភាព</p>
                            <p class="khmer-moul text-[11pt] mt-1">នាយក</p>
                        </div>
                        <div class="sig-col">
                            <p class="khmer-moul text-[11pt] -mt-1 ml-4">គ្រូបន្ទុកថ្នាក់</p>
                        </div>
                    </div>

                    <div class="signature-grid mt-16">
                        <div class="sig-col"></div>
                        <div class="sig-col">
                             <p class="khmer-moul text-[11pt] ml-4" id="pdf-teacher-name"></p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Student Modal -->
    <div id="student-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-2xl shadow-2xl overflow-hidden">
            <div class="bg-indigo-900 p-4 text-white flex justify-between">
                <h3 class="khmer-moul text-lg">បញ្ចូលព័ត៌មានសិស្ស</h3>
                <button onclick="closeModal('student-modal')">✕</button>
            </div>
            <form id="student-form" class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div class="flex flex-col">
                        <label class="text-sm font-bold mb-1">រូបថតសិស្ស</label>
                        <input type="file" id="stu-photo" accept="image/*" class="text-xs border p-1 rounded-lg">
                    </div>
                    <div class="flex flex-col"><label class="text-sm font-bold mb-1">អត្តលេខ</label><input type="text" id="stu-code" required class="border p-2 rounded-lg"></div>
                    <div class="flex flex-col"><label class="text-sm font-bold mb-1">ឈ្មោះសិស្ស</label><input type="text" id="stu-name" required class="border p-2 rounded-lg"></div>
                    <div class="flex flex-col">
                        <label class="text-sm font-bold mb-1">ភេទ</label>
                        <select id="stu-gender" class="border p-2 rounded-lg"><option value="ប្រុស">ប្រុស</option><option value="ស្រី">ស្រី</option></select>
                    </div>
                    <div class="flex flex-col"><label class="text-sm font-bold mb-1">ឈ្មោះអាណាព្យាបាល</label><input type="text" id="stu-parent" class="border p-2 rounded-lg"></div>
                    <div class="flex flex-col"><label class="text-sm font-bold mb-1">លេខទូរស័ព្ទ</label><input type="text" id="stu-phone" class="border p-2 rounded-lg"></div>
                    <div class="flex flex-col md:col-span-2"><label class="text-sm font-bold mb-1">ថ្នាក់រៀន</label><select id="stu-class" required class="border p-2 rounded-lg"></select></div>
                </div>
                <div class="flex justify-end gap-3 mt-8 border-t pt-5">
                    <button type="button" onclick="closeModal('student-modal')" class="bg-gray-100 px-6 py-2 rounded-xl">បោះបង់</button>
                    <button type="submit" class="bg-indigo-600 text-white px-8 py-2 rounded-xl font-bold">រក្សាទុក</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Class Modal -->
    <div id="class-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden">
            <div class="bg-indigo-900 p-4 text-white"><h3 class="khmer-moul text-lg">បង្កើតថ្នាក់រៀនថ្មី</h3></div>
            <div class="p-6 space-y-4">
                <div class="flex flex-col"><label class="text-sm font-bold mb-1">ឈ្មោះថ្នាក់</label><input type="text" id="class-name-input" class="border p-2 rounded-lg"></div>
                <div class="flex flex-col"><label class="text-sm font-bold mb-1">អង្គភាព</label><input type="text" id="class-org-input" class="border p-2 rounded-lg"></div>
                <div class="flex flex-col"><label class="text-sm font-bold mb-1">សាលារៀន</label><input type="text" id="class-school-input" class="border p-2 rounded-lg"></div>
                <div class="flex flex-col"><label class="text-sm font-bold mb-1">រាជធានី/ខេត្ត</label><input type="text" id="class-location-input" value="រាជធានីភ្នំពេញ" class="border p-2 rounded-lg"></div>
                <div class="flex flex-col"><label class="text-sm font-bold mb-1">ឈ្មោះគ្រូបន្ទុកថ្នាក់</label><input type="text" id="class-teacher-input" class="border p-2 rounded-lg"></div>
                <div class="flex justify-end gap-3 mt-6">
                    <button onclick="closeModal('class-modal')" class="bg-gray-100 px-6 py-2 rounded-xl">បោះបង់</button>
                    <button onclick="addClass()" class="bg-indigo-600 text-white px-8 py-2 rounded-xl font-bold">បង្កើត</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-attendance-app';

        let user = null;
        let classes = [];
        let students = [];
        let attendances = [];
        let currentClassId = '';

        const init = async () => {
            await signInAnonymously(auth);
            onAuthStateChanged(auth, (u) => {
                user = u;
                if (user) subscribeToData();
            });
        };

        const subscribeToData = () => {
            onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'classes'), (snap) => {
                classes = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                updateClassDropdowns();
            });
            onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'students'), (snap) => {
                students = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderStudentUI();
                loadAttendanceList();
            });
            onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'attendance'), (snap) => {
                attendances = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                loadAttendanceList();
                updateReportData();
            });
        };

        window.switchTab = (id) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${id}`).classList.remove('hidden');
            if (id === 'reports') updateReportData();
        };

        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');

        window.addClass = async () => {
            const data = {
                name: document.getElementById('class-name-input').value,
                org: document.getElementById('class-org-input').value,
                school: document.getElementById('class-school-input').value,
                location: document.getElementById('class-location-input').value,
                teacher: document.getElementById('class-teacher-input').value
            };
            if (data.name && user) {
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'classes'), data);
                closeModal('class-modal');
            }
        };

        const updateClassDropdowns = () => {
            const sels = ['select-class-attendance', 'stu-class'];
            const sidebar = document.getElementById('class-list-sidebar');
            const options = '<option value="">ជ្រើសរើសថ្នាក់</option>' + classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            sels.forEach(id => { if(document.getElementById(id)) document.getElementById(id).innerHTML = options; });
            sidebar.innerHTML = classes.map(c => `
                <li class="p-3 cursor-pointer rounded-xl hover:bg-indigo-50 flex justify-between items-center ${currentClassId === c.id ? 'bg-indigo-100 font-bold' : ''}" onclick="window.selectClass('${c.id}')">
                    <span>${c.name}</span>
                    <button onclick="window.deleteClass(event, '${c.id}')" class="text-red-400">លុប</button>
                </li>`).join('');
        };

        window.selectClass = (id) => {
            currentClassId = id;
            updateClassDropdowns();
            renderStudentUI();
            loadAttendanceList();
        };

        document.getElementById('student-form').onsubmit = async (e) => {
            e.preventDefault();
            const photoFile = document.getElementById('stu-photo').files[0];
            let photoBase64 = "";

            if (photoFile) {
                photoBase64 = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.readAsDataURL(photoFile);
                });
            }

            const data = {
                code: document.getElementById('stu-code').value,
                name: document.getElementById('stu-name').value,
                gender: document.getElementById('stu-gender').value,
                parent: document.getElementById('stu-parent').value,
                phone: document.getElementById('stu-phone').value,
                classId: document.getElementById('stu-class').value,
                photo: photoBase64
            };
            await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'students'), data);
            closeModal('student-modal');
            e.target.reset();
        };

        window.deleteStudent = async (id) => {
            if(confirm("លុបសិស្សនេះ?")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'students', id));
            }
        };

        window.deleteClass = async (e, id) => {
            e.stopPropagation();
            if(confirm("លុបថ្នាក់នេះ?")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'classes', id));
            }
        };

        const renderStudentUI = () => {
            const list = currentClassId ? students.filter(s => s.classId === currentClassId) : students;
            document.getElementById('student-list-table').innerHTML = list.map(s => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-4">${s.code}</td>
                    <td class="p-4">
                        <img src="${s.photo || 'https://via.placeholder.com/50x60?text=S'}" class="student-photo-box" />
                    </td>
                    <td class="p-4 font-bold text-indigo-900">${s.name}</td>
                    <td class="p-4">
                        <div class="text-xs text-gray-500">${s.parent || '-'}</div>
                        <div class="font-bold text-xs">${s.phone || '-'}</div>
                    </td>
                    <td class="p-4 text-center">${s.gender}</td>
                    <td class="p-4 text-right">
                        <button onclick="window.deleteStudent('${s.id}')" class="text-red-500 hover:bg-red-50 p-2 rounded-lg transition">លុប</button>
                    </td>
                </tr>`).join('');
        };

        window.loadAttendanceList = () => {
            const classId = document.getElementById('select-class-attendance').value || currentClassId;
            const date = document.getElementById('attendance-date').value;
            if (!classId || !date) return;
            
            const classStudents = students.filter(s => s.classId === classId);
            const record = attendances.find(a => a.date === date && a.classId === classId);

            document.getElementById('attendance-list').innerHTML = classStudents.length === 0 ? 
                '<tr><td colspan="5" class="p-10 text-center">មិនទាន់មានសិស្សក្នុងថ្នាក់នេះ</td></tr>' :
                classStudents.map((s, i) => {
                const status = record?.records?.[s.id] || 'present';
                return `
                <tr class="border-b">
                    <td class="p-4 text-center">${i+1}</td>
                    <td class="p-4"><img src="${s.photo || 'https://via.placeholder.com/50x60'}" class="student-photo-box" /></td>
                    <td class="p-4 font-bold">${s.name}</td>
                    <td class="p-4 text-center">
                        <div class="flex justify-center gap-1">
                            <button onclick="this.parentElement.querySelector('.selected').classList.remove('selected', 'bg-green-500', 'text-white'); this.classList.add('selected', 'bg-green-500', 'text-white')" class="status-btn px-2 py-1 rounded text-xs border ${status==='present'?'selected bg-green-500 text-white':''}" data-val="present">មក</button>
                            <button onclick="this.parentElement.querySelector('.selected').classList.remove('selected', 'bg-green-500', 'text-white'); this.classList.add('selected', 'bg-orange-500', 'text-white')" class="status-btn px-2 py-1 rounded text-xs border ${status==='permission'?'selected bg-orange-500 text-white':''}" data-val="permission">ច្បាប់</button>
                            <button onclick="this.parentElement.querySelector('.selected').classList.remove('selected', 'bg-green-500', 'text-white'); this.classList.add('selected', 'bg-red-500', 'text-white')" class="status-btn px-2 py-1 rounded text-xs border ${status==='absent'?'selected bg-red-500 text-white':''}" data-val="absent">អវត្តមាន</button>
                        </div>
                    </td>
                    <td class="p-4"><input type="text" id="note-${s.id}" value="${record?.notes?.[s.id] || ''}" class="border p-1 w-full text-xs rounded"></td>
                </tr>`;
            }).join('');
        };

        window.saveAttendance = async () => {
            const date = document.getElementById('attendance-date').value;
            const classId = document.getElementById('select-class-attendance').value || currentClassId;
            if(!classId || !date) return;

            const records = {}; const notes = {};
            document.querySelectorAll('#attendance-list tr').forEach((tr, i) => {
                const sid = students.filter(s => s.classId === classId)[i]?.id;
                if(sid) {
                    records[sid] = tr.querySelector('.selected').getAttribute('data-val');
                    notes[sid] = tr.querySelector('input').value;
                }
            });

            await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'attendance', `${date}_${classId}`), { date, classId, records, notes });
            alert("រក្សាទុកវត្តមានរួចរាល់");
        };

        window.updateReportData = () => {
            const classId = document.getElementById('select-class-attendance').value || currentClassId;
            const rType = document.getElementById('report-type').value;
            const target = classes.find(c => c.id === classId);
            
            document.getElementById('pdf-report-title').innerText = `របាយការណ៍វត្តមានសិស្សប្រចាំ${rType}`;

            if (target) {
                document.getElementById('pdf-org-unit').innerText = target.org || '';
                document.getElementById('pdf-school-name').innerText = target.school || '';
                document.getElementById('pdf-class-name').innerText = target.name ? `ថ្នាក់៖ ${target.name}` : '';
                document.getElementById('pdf-teacher-name').innerText = target.teacher || '';
                document.getElementById('pdf-solar-date').innerText = `${target.location || 'រាជធានីភ្នំពេញ'} ថ្ងៃទី${new Date().getDate()} ខែ${new Date().getMonth()+1} ឆ្នាំ${new Date().getFullYear()}`;
            }
            
            const classStudents = students.filter(s => s.classId === classId);
            const classAtt = attendances.filter(a => a.classId === classId);

            document.getElementById('pdf-report-body').innerHTML = classStudents.map((s, i) => {
                let p = 0, per = 0, ab = 0;
                classAtt.forEach(at => {
                    const st = at.records?.[s.id];
                    if (st === 'present') p++; else if (st === 'permission') per++; else if (st === 'absent') ab++;
                });
                const total = classAtt.length || 1;
                return `<tr>
                    <td class="border border-black p-1 text-center">${i+1}</td>
                    <td class="border border-black p-1 text-center text-xs font-mono">${s.code}</td>
                    <td class="border border-black p-1">${s.name}</td>
                    <td class="border border-black p-1 text-center">${s.gender}</td>
                    <td class="border border-black p-1 text-center">${p}</td>
                    <td class="border border-black p-1 text-center">${per}</td>
                    <td class="border border-black p-1 text-center">${ab}</td>
                    <td class="border border-black p-1 text-center font-bold">${((p/total)*100).toFixed(0)}%</td>
                </tr>`;
            }).join('');
        };

        window.generatePDF = () => {
            const element = document.getElementById('pdf-content');
            const rType = document.getElementById('report-type').value;
            html2pdf().from(element).set({
                margin: 0.2,
                filename: `Attendance_${rType}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            }).save();
        };

        window.onload = () => {
            document.getElementById('attendance-date').value = new Date().toISOString().split('T')[0];
            init();
        };
    </script>
</body>
</html>