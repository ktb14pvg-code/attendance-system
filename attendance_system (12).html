<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>á”áŸ’ášá–áŸá“áŸ’á’á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„áœááŸ’áá˜á¶á“áŸá·áŸáŸ’áŸ (Online Firebase)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@300;400;700&family=Moul&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Kantumruy Pro',sans-serif;}
    .khmer-moul{font-family:'Moul',serif;}
    .student-photo{width:50px;height:60px;border:1px solid #ddd;object-fit:cover;border-radius:4px;}
    @media print{.no-print{display:none;}}
  </style>
</head>
<body class="bg-gray-100">

<!-- LOGIN -->
<div id="login-screen" class="min-h-screen flex items-center justify-center">
  <div class="bg-white p-8 rounded shadow w-full max-w-md">
    <h2 class="khmer-moul text-xl text-center mb-4">á…á¼á›á”áŸ’ášá¾á”áŸ’ášá¶áŸáŸ‹á”áŸ’ášá–áŸá“áŸ’á’</h2>
    <input id="login-email" type="email" placeholder="Email" class="border p-2 w-full mb-3 rounded" />
    <input id="login-password" type="password" placeholder="Password" class="border p-2 w-full mb-3 rounded" />
    <div id="login-error" class="text-red-600 text-sm mb-2"></div>
    <button id="btn-login" class="bg-indigo-600 text-white w-full py-2 rounded mb-2">á…á¼á›á”áŸ’ášá¾</button>
    <button id="btn-show-register" class="bg-green-600 text-white w-full py-2 rounded">á”á„áŸ’á€á¾áá‚áá“á¸ááŸ’á˜á¸</button>
  </div>
</div>

<!-- REGISTER -->
<div id="register-screen" class="hidden min-h-screen flex items-center justify-center">
  <div class="bg-white p-8 rounded shadow w-full max-w-md">
    <h2 class="khmer-moul text-xl text-center mb-4">á”á„áŸ’á€á¾áá‚áá“á¸ááŸ’á˜á¸</h2>
    <input id="reg-email" type="email" placeholder="Email" class="border p-2 w-full mb-3 rounded" />
    <input id="reg-password" type="password" placeholder="Password (>=6 áá½á¢á€áŸ’áŸáš)" class="border p-2 w-full mb-3 rounded" />
    <input id="reg-confirm" type="password" placeholder="á”á‰áŸ’á‡á¶á€áŸ‹ Password á˜áŸ’áá„á‘áŸ€á" class="border p-2 w-full mb-3 rounded" />
    <div id="reg-error" class="text-red-600 text-sm mb-2"></div>
    <button id="btn-register" class="bg-green-600 text-white w-full py-2 rounded mb-2">á”á„áŸ’á€á¾áá‚áá“á¸</button>
    <button id="btn-show-login" class="bg-gray-600 text-white w-full py-2 rounded">ááŸ’ášá¡á”áŸ‹á‘áŸ… Login</button>
  </div>
</div>

<!-- APP -->
<div id="app" class="hidden">
<nav class="bg-indigo-900 text-white p-4 shadow-lg no-print">
  <div class="max-w-6xl mx-auto flex justify-between">
    <span class="khmer-moul text-xl">á”áŸ’ášá–áŸá“áŸ’á’áœááŸ’áá˜á¶á“áŸá·áŸáŸ’áŸ (Online)</span>
    <div class="space-x-2">
      <button data-tab="attendance" class="tab-btn px-3 py-1 bg-indigo-600 rounded">á€ááŸ‹áœááŸ’áá˜á¶á“</button>
      <button data-tab="students" class="tab-btn px-3 py-1 bg-indigo-600 rounded">á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„áŸá·áŸáŸ’áŸ</button>
      <button data-tab="reports" class="tab-btn px-3 py-1 bg-indigo-600 rounded">ášá”á¶á™á€á¶ášááŸ</button>
      <button id="btn-logout" class="px-3 py-1 bg-red-600 rounded">á…á¶á€á…áŸá‰</button>
    </div>
  </div>
</nav>

<div class="max-w-6xl mx-auto p-6">

<!-- ATTENDANCE -->
<div id="tab-attendance" class="hidden">
  <div class="bg-white p-4 rounded shadow">
    <h3 class="khmer-moul mb-2">á€ááŸ‹áœááŸ’áá˜á¶á“á”áŸ’ášá…á¶áŸ†ááŸ’á„áŸƒ</h3>
    <div class="flex gap-2 mb-3">
      <input type="date" id="att-date" class="border p-2 rounded">
      <select id="att-class" class="border p-2 rounded"></select>
      <button id="btn-load-att" class="bg-indigo-600 text-white px-4 rounded">á”á„áŸ’á á¶á‰</button>
    </div>
    <table class="w-full border">
      <thead class="bg-gray-200">
        <tr><th>á›.áš</th><th>áˆáŸ’á˜áŸ„áŸ‡</th><th class="text-center">áœááŸ’áá˜á¶á“</th><th>á˜á¼á›á áŸáá» (á…áŸ’á”á¶á”áŸ‹/á¢áœááŸ’áá˜á¶á“)</th></tr>
      </thead>
      <tbody id="att-list"></tbody>
    </table>
    <button id="btn-save-att" class="bg-green-600 text-white px-4 py-2 mt-3 rounded">ášá€áŸ’áŸá¶á‘á»á€áœááŸ’áá˜á¶á“</button>
  </div>
</div>

<!-- STUDENTS -->
<div id="tab-students" class="hidden">

<!-- CLASS FORM MODAL -->
<div id="class-form-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded w-full max-w-md">
    <h3 class="khmer-moul mb-3">á”á„áŸ’á€á¾áááŸ’á“á¶á€áŸ‹</h3>
    <input id="cf-org" class="border p-2 w-full mb-2" placeholder="á¢á„áŸ’á‚á—á¶á–á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„">
    <input id="cf-school" class="border p-2 w-full mb-2" placeholder="áˆáŸ’á˜áŸ„áŸ‡áŸá¶á›á¶">
    <input id="cf-name" class="border p-2 w-full mb-2" placeholder="ááŸ’á“á¶á€áŸ‹">
    <input id="cf-city" class="border p-2 w-full mb-2" placeholder="á‘á¸á€á“áŸ’á›áŸ‚á„">
    <input id="cf-teacher" class="border p-2 w-full mb-2" placeholder="á‚áŸ’ášá¼á”á“áŸ’á‘á»á€ááŸ’á“á¶á€áŸ‹">
    <div class="flex gap-2">
      <button id="btn-save-class" class="bg-green-600 text-white px-4 py-1 rounded">ášá€áŸ’áŸá¶á‘á»á€</button>
      <button id="btn-close-class" class="bg-gray-500 text-white px-4 py-1 rounded">á”á·á‘</button>
    </div>
  </div>
</div>

<!-- STUDENT FORM MODAL -->
<div id="student-form-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded w-full max-w-md">
    <h3 class="khmer-moul mb-3">á”á“áŸ’ááŸ‚á˜áŸá·áŸáŸ’áŸ</h3>
    <input id="sf-code" class="border p-2 w-full mb-2" placeholder="á¢ááŸ’áá›áŸá">
    <input id="sf-name" class="border p-2 w-full mb-2" placeholder="áˆáŸ’á˜áŸ„áŸ‡áŸá·áŸáŸ’áŸ">
    <input id="sf-gender" class="border p-2 w-full mb-2" placeholder="á—áŸá‘">
    <input id="sf-dob" class="border p-2 w-full mb-2" placeholder="ááŸ’á„áŸƒá€áŸ†áá¾á">
    <input id="sf-parent" class="border p-2 w-full mb-2" placeholder="á¢á¶áá¶á–áŸ’á™á¶á”á¶á›">
    <input id="sf-phone" class="border p-2 w-full mb-2" placeholder="á›áŸáá‘á¼ášáŸáŸá–áŸ’á‘">
    <select id="sf-class" class="border p-2 w-full mb-2"></select>
    <input id="sf-photo" type="file" accept="image/*" class="mb-2">
    <div class="flex gap-2">
      <button id="btn-save-student" class="bg-green-600 text-white px-4 py-1 rounded">ášá€áŸ’áŸá¶á‘á»á€</button>
      <button id="btn-close-student" class="bg-gray-500 text-white px-4 py-1 rounded">á”á·á‘</button>
    </div>
  </div>
</div>

  <div class="flex gap-2 mb-3 no-print">
    <button id="btn-add-class" class="bg-indigo-600 text-white px-3 rounded">+ á”á„áŸ’á€á¾áááŸ’á“á¶á€áŸ‹</button>
    <button id="btn-add-student" class="bg-green-600 text-white px-3 rounded">+ á”á“áŸ’ááŸ‚á˜áŸá·áŸáŸ’áŸ</button>
    <select id="stu-class-filter" class="border p-2 rounded"></select>
    <button id="btn-load-students" class="bg-gray-600 text-white px-3 rounded">á”á„áŸ’á á¶á‰</button>
  </div>

  <table class="w-full bg-white shadow rounded">
    <thead class="bg-gray-200">
      <tr>
        <th>á›.áš</th><th>ášá¼á”</th><th>áˆáŸ’á˜áŸ„áŸ‡</th><th>á—áŸá‘</th><th>ááŸ’á„áŸƒá€áŸ†áá¾á</th><th>á¢á¶áá¶á–áŸ’á™á¶á”á¶á›</th><th>á›áŸáá‘á¼ášáŸáŸá–áŸ’á‘</th><th>ááŸ’á“á¶á€áŸ‹</th>
      </tr>
    </thead>
    <tbody id="stu-list"></tbody>
  </table>
</div>

<!-- REPORTS -->
<div id="tab-reports" class="hidden">
  <div class="flex gap-2 mb-4 no-print">
    <select id="report-type" class="border p-2 rounded">
      <option value="day">á”áŸ’ášá…á¶áŸ†ááŸ’á„áŸƒ</option>
      <option value="week">á”áŸ’ášá…á¶áŸ†áŸá”áŸ’áŠá¶á áŸ</option>
      <option value="month" selected>á”áŸ’ášá…á¶áŸ†ááŸ‚</option>
      <option value="quarter">á”áŸ’ášá…á¶áŸ†ááŸ’ášá¸á˜á¶áŸ</option>
      <option value="semester">á”áŸ’ášá…á¶áŸ†á†á˜á¶áŸ</option>
    </select>
    <select id="report-class" class="border p-2 rounded"></select>
    <button id="btn-pdf" class="bg-red-600 text-white px-4 rounded">á‘á¶á‰á™á€ PDF</button>
  </div>

  <div id="pdf-content" class="bg-white p-12 shadow max-w-4xl mx-auto text-black">
    <div class="mb-2">
      <div id="pdf-org" class="text-sm text-left"></div>
      <div id="pdf-school" class="text-sm text-left"></div>
      <div id="pdf-class" class="text-sm text-left"></div>
      <div class="text-center">
        <h1 class="khmer-moul text-xl">á–áŸ’ášáŸ‡ášá¶á‡á¶áá¶á…á€áŸ’ášá€á˜áŸ’á–á»á‡á¶</h1>
        <h2 class="khmer-moul text-lg">á‡á¶áá· áŸá¶áŸá“á¶ á–áŸ’ášáŸ‡á˜á á¶á€áŸ’áŸááŸ’áš</h2>
      </div>
    </div>

    <h3 id="report-title" class="khmer-moul text-center mb-4 underline">ášá”á¶á™á€á¶ášááŸáœááŸ’áá˜á¶á“áŸá·áŸáŸ’áŸ</h3>

    <table class="w-full border-collapse border border-black text-sm mb-6">
      <thead class="bg-gray-100">
        <tr>
          <th class="border p-1">á›.áš</th>
          <th class="border p-1">áˆáŸ’á˜áŸ„áŸ‡áŸá·áŸáŸ’áŸ</th>
          <th class="border p-1">á˜á€</th>
          <th class="border p-1">á…áŸ’á”á¶á”áŸ‹</th>
          <th class="border p-1">á¢áœááŸ’áá˜á¶á“</th>
          <th class="border p-1">á—á¶á‚ášá™ %</th>
        </tr>
      </thead>
      <tbody id="report-body"></tbody>
    </table>

    <div class="text-right text-sm">
      <p id="pdf-lunar"></p>
      <p id="pdf-solar"></p>
    </div>

    <div class="grid grid-cols-2 mt-8 text-sm">
      <div class="text-center">
        <p class="khmer-moul">á”á¶á“áƒá¾á‰ á“á·á„á¯á€á—á¶á–</p>
        <p class="khmer-moul">á“á¶á™á€</p>
      </div>
      <div class="text-center">
        <p class="khmer-moul">á‚áŸ’ášá¼á”á“áŸ’á‘á»á€ááŸ’á“á¶á€áŸ‹</p>
        <p id="pdf-teacher" class="khmer-moul"></p>
      </div>
    </div>
  </div>
</div>

</div>
</div>

<!-- UI LOGIC + FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
};

const app = initializeApp(firebaseConfig);

// --- Khmer date helpers ---
function getKhmerSolarDate() {
  const now = new Date();
  const options = { year:'numeric', month:'long', day:'numeric' };
  const khDate = now.toLocaleDateString('km-KH', options);
  return `ášá¶á‡á’á¶á“á¸á—áŸ’á“áŸ†á–áŸá‰  ááŸ’á„áŸƒá‘á¸${khDate.replace(' ', '  ')}`;
}

// Placeholder lunar (can be replaced by real lunar lib later)
function getKhmerLunarDate(){
  const now = new Date();
  return now.toLocaleDateString('km-KH',{weekday:'long', year:'numeric', month:'long', day:'numeric'});
}

const auth = getAuth(app);
const db = getFirestore(app);

let userId = null;
let classes = [];
let students = [];
let attendance = [];

// ---------- AUTH UI ----------
const loginScreen = document.getElementById('login-screen');
const registerScreen = document.getElementById('register-screen');
const appDiv = document.getElementById('app');

// Tabs
function initTabs() {
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.onclick = () => switchTab(btn.dataset.tab);
  });
  switchTab('students');
}

function switchTab(tab) {
  ['attendance','students','reports'].forEach(t => {
    const el = document.getElementById('tab-' + t);
    if (el) el.classList.add('hidden');
  });
  const active = document.getElementById('tab-' + tab);
  if (active) active.classList.remove('hidden');
}

// ---------- ATTENDANCE ----------
document.getElementById('btn-load-att').onclick = loadAttendance;
document.getElementById('btn-save-att').onclick = saveAttendance;

function loadAttendance() {
  const date = document.getElementById('att-date').value;
  const cls = document.getElementById('att-class').value;
  if (!date || !cls) return;

  const list = students.filter(s=>s.classId===cls);
  const rec = attendance.find(a=>a.date===date && a.classId===cls);

  document.getElementById('att-list').innerHTML = list.map((s,i)=>{
    const st = rec?.records?.[s.id]?.status || 'present';
    const reason = rec?.records?.[s.id]?.reason || '';
    return `<tr>
      <td>${i+1}</td>
      <td>${s.name}</td>
      <td class="text-center">
        <div class="flex justify-center gap-3 text-xl">
          <button class="att-btn" data-stu="${s.id}" data-status="present">${st==='present'?'ğŸŸ¢':'âšª'}</button>
          <button class="att-btn" data-stu="${s.id}" data-status="permission">${st==='permission'?'ğŸŸ¡':'âšª'}</button>
          <button class="att-btn" data-stu="${s.id}" data-status="absent">${st==='absent'?'ğŸ”´':'âšª'}</button>
        </div>
      </td>
      <td><input type="text" id="reason-${s.id}" class="border p-1 w-full" value="${reason}" placeholder="á”áŸ†á–áŸá‰á˜á¼á›á áŸáá»..."></td>
    </tr>`;
  }).join('');

  document.querySelectorAll('.att-btn').forEach(btn=>{
    btn.onclick = ()=>{
      const sid = btn.dataset.stu;
      const status = btn.dataset.status;
      document.querySelectorAll(`.att-btn[data-stu='${sid}']`).forEach(b=>b.textContent='âšª');
      btn.textContent = status==='present'?'ğŸŸ¢':status==='permission'?'ğŸŸ¡':'ğŸ”´';
      btn.closest('tr').dataset.status = status;
    };
  });
}

async function saveAttendance() {
  const date = document.getElementById('att-date').value;
  const cls = document.getElementById('att-class').value;
  if (!date || !cls) return;

  const records = {};
  document.querySelectorAll('#att-list tr').forEach(tr=>{
    const sid = tr.querySelector('.att-btn').dataset.stu;
    const status = tr.dataset.status || 'present';
    const reason = document.getElementById('reason-'+sid).value || '';
    records[sid] = {status,reason};
  });

  await addDoc(collection(db,'users',userId,'attendance'), {date, classId:cls, records});
  alert('ášá€áŸ’áŸá¶á‘á»á€ášá½á…ášá¶á›áŸ‹');
}

// ---------- REPORT HEADER RENDER ----------
function updateReportHeader(){
  const cls = classes.find(c=>c.id===document.getElementById('report-class').value);
  if(!cls) return;
  document.getElementById('pdf-org').textContent = cls.org || '';
  document.getElementById('pdf-school').textContent = cls.school || '';
  document.getElementById('pdf-class').textContent = 'ááŸ’á“á¶á€áŸ‹ ' + (cls.name||'');
  document.getElementById('pdf-teacher').textContent = cls.teacher || '';
  document.getElementById('pdf-lunar').textContent = getKhmerLunarDate();
  document.getElementById('pdf-solar').textContent = getKhmerSolarDate();
  const type = document.getElementById('report-type').value;
  const titles = {day:'ášá”á¶á™á€á¶ášááŸá”áŸ’ášá…á¶áŸ†ááŸ’á„áŸƒ',week:'ášá”á¶á™á€á¶ášááŸá”áŸ’ášá…á¶áŸ†áŸá”áŸ’áŠá¶á áŸ',month:'ášá”á¶á™á€á¶ášááŸá”áŸ’ášá…á¶áŸ†ááŸ‚',quarter:'ášá”á¶á™á€á¶ášááŸá”áŸ’ášá…á¶áŸ†ááŸ’ášá¸á˜á¶áŸ',semester:'ášá”á¶á™á€á¶ášááŸá”áŸ’ášá…á¶áŸ†á†á˜á¶áŸ'};
  document.getElementById('report-title').textContent = titles[type];
}

document.getElementById('report-type').onchange = updateReportHeader;
document.getElementById('report-class').onchange = updateReportHeader;

// ---------- BASIC RUNTIME TESTS ----------
console.assert(document.getElementById('login-screen'), 'login-screen missing');
console.assert(document.getElementById('tab-students'), 'tab-students missing');
console.assert(typeof switchTab === 'function', 'switchTab not defined');
</script>
</body>
</html>
