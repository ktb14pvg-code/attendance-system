<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>á”áŸ’ášá–áŸá“áŸ’á’á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„áœááŸ’áá˜á¶á“áŸá·áŸáŸ’áŸ (Online Firebase)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@300;400;700&family=Moul&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Kantumruy Pro',sans-serif;}
    .khmer-moul{font-family:'Moul',serif;}
    .student-photo{width:50px;height:60px;border:1px solid #ddd;object-fit:cover;border-radius:4px;}
    @media print{.no-print{display:none;}}
  </style>
</head>
<body class="bg-gray-100">

<!-- Loading Screen -->
<div id="status" class="min-h-screen flex flex-col items-center justify-center">
  <h2 class="khmer-moul text-2xl text-gray-500">Connecting to Firebase...</h2>
</div>

<!-- Main App -->
<div id="app" class="hidden">

<nav class="bg-indigo-900 text-white p-4 shadow-lg no-print">
  <div class="max-w-6xl mx-auto flex justify-between">
    <span class="khmer-moul text-xl">á”áŸ’ášá–áŸá“áŸ’á’áœááŸ’áá˜á¶á“áŸá·áŸáŸ’áŸ (Online)</span>
    <span id="user-id" class="text-xs"></span>
  </div>
</nav>

<div class="max-w-6xl mx-auto p-6">
  <!-- Tabs -->
  <div class="flex space-x-4 mb-6 no-print">
    <button onclick="switchTab('attendance')" class="px-4 py-2 bg-indigo-600 text-white rounded">á€ááŸ‹áœááŸ’áá˜á¶á“</button>
    <button onclick="switchTab('students')" class="px-4 py-2 bg-indigo-600 text-white rounded">á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„áŸá·áŸáŸ’áŸ</button>
    <button onclick="switchTab('reports')" class="px-4 py-2 bg-indigo-600 text-white rounded">ášá”á¶á™á€á¶ášááŸ</button>
  </div>

  <!-- Attendance -->
  <div id="tab-attendance">
    <div class="flex gap-4 mb-4">
      <input type="date" id="att-date" class="border p-2 rounded" />
      <select id="att-class" class="border p-2 rounded"></select>
      <button onclick="loadAttendance()" class="bg-green-600 text-white px-4 rounded">á”á„áŸ’á á¶á‰</button>
    </div>
    <table class="w-full bg-white shadow rounded">
      <thead class="bg-gray-200">
        <tr><th>á›.áš</th><th>ášá¼á”</th><th>áˆáŸ’á˜áŸ„áŸ‡</th><th>áŸáŸ’áá¶á“á—á¶á–</th><th>á…áŸ†áá¶áŸ†</th></tr>
      </thead>
      <tbody id="att-list"></tbody>
    </table>
    <button onclick="saveAttendance()" class="mt-4 bg-indigo-600 text-white px-4 py-2 rounded no-print">ášá€áŸ’áŸá¶á‘á»á€</button>
  </div>

  <!-- Students -->
  <div id="tab-students" class="hidden">
    <div class="flex justify-between mb-4 no-print">
      <button onclick="openStudentModal()" class="bg-indigo-600 text-white px-4 py-2 rounded">+ á”á“áŸ’ááŸ‚á˜áŸá·áŸáŸ’áŸ</button>
      <button onclick="openClassModal()" class="bg-indigo-600 text-white px-4 py-2 rounded">+ á”á„áŸ’á€á¾áááŸ’á“á¶á€áŸ‹</button>
    </div>

    <div class="flex gap-4 mb-4">
      <select id="stu-class-filter" class="border p-2 rounded"></select>
      <button onclick="loadStudents()" class="bg-green-600 text-white px-4 rounded">á”á„áŸ’á á¶á‰</button>
    </div>

    <table class="w-full bg-white shadow rounded">
      <thead class="bg-gray-200">
        <tr><th>á›.áš</th><th>ášá¼á”</th><th>áˆáŸ’á˜áŸ„áŸ‡</th><th>á—áŸá‘</th><th>ááŸ’á„áŸƒá€áŸ†áá¾á</th><th>á¢á¶áá¶á–áŸ’á™á¶á”á¶á›</th><th>á‘á¼ášáŸáŸá–áŸ’á‘</th><th>ááŸ’á“á¶á€áŸ‹</th><th class="no-print">áŸá€á˜áŸ’á˜á—á¶á–</th></tr>
      </thead>
      <tbody id="stu-list"></tbody>
    </table>
  </div>

  <!-- Reports -->
  <div id="tab-reports" class="hidden">
    <div class="flex justify-between mb-4 no-print">
      <select id="report-type" class="border p-2 rounded">
        <option value="day">ááŸ’á„áŸƒ</option>
        <option value="week">áŸá”áŸ’áá¶á áŸ</option>
        <option value="month" selected>ááŸ‚</option>
        <option value="semester">á†á˜á¶áŸ</option>
      </select>
      <button onclick="generatePDF()" class="bg-red-600 text-white px-4 py-2 rounded">á‘á¶á‰á™á€ PDF</button>
    </div>

    <div id="pdf-content" class="bg-white p-12 shadow max-w-4xl mx-auto text-black">
      <div class="text-center mb-2">
        <h1 class="khmer-moul text-xl">á–áŸ’ášáŸ‡ášá¶á‡á¶áá¶á…á€áŸ’ášá€á˜áŸ’á–á»á‡á¶</h1>
        <h2 class="khmer-moul text-lg">á‡á¶áá· áŸá¶áŸá“á¶ á–áŸ’ášáŸ‡á˜á á¶á€áŸ’áŸááŸ’áš</h2>
        <div class="flex justify-center my-1">
          <img src="https://lh3.googleusercontent.com/u/0/d/1BnGzoisjHxGRiMbsrP-rZ1F9zvSfdtAh" class="h-6 object-contain" />
        </div>
        <div class="my-1">ï‚šï‚šï‚šï€¦ï‚›ï‚›ï‚›</div>
        <div id="school-info" class="text-sm"></div>
      </div>

      <h3 id="report-title" class="khmer-moul text-center mb-4 underline">ášá”á¶á™á€á¶ášááŸáœááŸ’áá˜á¶á“áŸá·áŸáŸ’áŸ</h3>

      <table class="w-full border-collapse border border-black text-sm mb-6">
        <thead class="bg-gray-100">
          <tr>
            <th class="border border-black p-1">á›.áš</th>
            <th class="border border-black p-1">áˆáŸ’á˜áŸ„áŸ‡áŸá·áŸáŸ’áŸ</th>
            <th class="border border-black p-1">á˜á€</th>
            <th class="border border-black p-1">á…áŸ’á”á¶á”áŸ‹</th>
            <th class="border border-black p-1">á¢áœááŸ’áá˜á¶á“</th>
            <th class="border border-black p-1">á—á¶á‚ášá™ %</th>
          </tr>
        </thead>
        <tbody id="report-body"></tbody>
      </table>

      <div class="text-right mt-4 text-sm">
        <p id="auto-date"></p>
      </div>

      <div class="grid grid-cols-2 mt-8 text-sm">
        <div class="text-center">
          <p class="khmer-moul">á”á¶á“áƒá¾á‰ á“á·á„á¯á€á—á¶á–</p>
          <p class="khmer-moul">á“á¶á™á€</p>
        </div>
        <div class="text-center">
          <p class="khmer-moul">á‚áŸ’ášá¼á”á“áŸ’á‘á»á€ááŸ’á“á¶á€áŸ‹</p>
          <p id="teacher-name" class="khmer-moul"></p>
        </div>
      </div>
    </div>

    <script>
    function buildReport(){
      const clsId=document.getElementById('att-class').value;
      const cls=classes.find(c=>c.id===clsId)||{};
      document.getElementById('school-info').innerHTML=
        `<p>${cls.school||''}</p><p>${cls.name||''}</p>`;

      const now=new Date();
      document.getElementById('auto-date').innerText=
        `ášá¶á‡á’á¶á“á¸á—áŸ’á“áŸ†á–áŸá‰ ááŸ’á„áŸƒá‘á¸${now.getDate()} ááŸ‚${now.getMonth()+1} á†áŸ’á“á¶áŸ†${now.getFullYear()}`;

      document.getElementById('teacher-name').innerText=cls.teacher||'';

      const clsStudents=students.filter(s=>s.classId===clsId);
      const rows=clsStudents.map((s,i)=>{
        let present=0,permission=0,absent=0;
        attendance.filter(a=>a.classId===clsId).forEach(a=>{
          const rec=a.records[s.id];
          if(rec){
            if(rec.status==='present') present++;
            if(rec.status==='permission') permission++;
            if(rec.status==='absent') absent++;
          }
        });
        const total=present+permission+absent;
        const percent=total?((present/total)*100).toFixed(0):'0';
        return `<tr>
          <td class="border border-black p-1 text-center">${i+1}</td>
          <td class="border border-black p-1">${s.name}</td>
          <td class="border border-black p-1 text-center">${present}</td>
          <td class="border border-black p-1 text-center">${permission}</td>
          <td class="border border-black p-1 text-center">${absent}</td>
          <td class="border border-black p-1 text-center">${percent}%</td>
        </tr>`;
      }).join('');
      document.getElementById('report-body').innerHTML=rows;
    }
    </script>

<script>
// Generate PDF
function generatePDF(){
  buildReport();
  const element=document.getElementById('pdf-content');
  html2pdf().from(element).set({
    margin:0.3,
    filename:'Attendance_Report.pdf',
    image:{type:'jpeg',quality:0.98},
    html2canvas:{scale:2,useCORS:true},
    jsPDF:{unit:'in',format:'a4',orientation:'portrait'}
  }).save();
}
</script>
<!-- Firebase Full Integration -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, doc, setDoc, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // ğŸ”¥ Firebase Config (Your Project)
  const firebaseConfig = {
    apiKey: "AIzaSyBIEQ5a6qS0uP0fRHs_5Bpw9cvRySxFk5A",
    authDomain: "attendance-students-kh.firebaseapp.com",
    projectId: "attendance-students-kh",
    storageBucket: "attendance-students-kh.firebasestorage.app",
    messagingSenderId: "61034722707",
    appId: "1:61034722707:web:a5dd06194f6dc179e52466"
  };

  // Init Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Global Data
  window.classes = [];
  window.students = [];
  window.attendance = [];
  let userId = null;

  // Sign In
  await signInAnonymously(auth);
  onAuthStateChanged(auth, (user) => {
    if(user){
      userId = user.uid;
      document.getElementById('status').classList.add('hidden');
      document.getElementById('app').classList.remove('hidden');
      document.getElementById('user-id').innerText = "User: " + user.uid.substring(0,6);
      subscribeData();
    }
  });

  // Subscribe Realtime Data
  function subscribeData(){
    onSnapshot(collection(db,'users',userId,'classes'), snap=>{
      classes = snap.docs.map(d=>({id:d.id,...d.data()}));
      refreshClassDropdowns();
    });

    onSnapshot(collection(db,'users',userId,'students'), snap=>{
      students = snap.docs.map(d=>({id:d.id,...d.data()}));
      loadStudents();
    });

    onSnapshot(collection(db,'users',userId,'attendance'), snap=>{
      attendance = snap.docs.map(d=>({id:d.id,...d.data()}));
    });
  }

  // Add Class
  window.openClassModal = async function(){
    const name = prompt('áˆáŸ’á˜áŸ„áŸ‡ááŸ’á“á¶á€áŸ‹');
    const school = prompt('áˆáŸ’á˜áŸ„áŸ‡áŸá¶á›á¶');
    const teacher = prompt('áˆáŸ’á˜áŸ„áŸ‡á‚áŸ’ášá¼á”á“áŸ’á‘á»á€');
    if(name){
      await addDoc(collection(db,'users',userId,'classes'),{name,school,teacher});
    }
  }

  // Refresh Dropdowns
  function refreshClassDropdowns(){
    const att = document.getElementById('att-class');
    const stu = document.getElementById('stu-class-filter');
    att.innerHTML = classes.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
    stu.innerHTML = att.innerHTML;
  }

  // Add Student
  window.openStudentModal = async function(){
    const name = prompt('áˆáŸ’á˜áŸ„áŸ‡áŸá·áŸáŸ’áŸ');
    const gender = prompt('á—áŸá‘');
    const cls = document.getElementById('stu-class-filter').value;
    if(name && cls){
      await addDoc(collection(db,'users',userId,'students'),{name,gender,classId:cls});
    }
  }

  // Load Students
  window.loadStudents = function(){
    const cls = document.getElementById('stu-class-filter').value;
    const list = students.filter(s=>!cls || s.classId===cls);
    document.getElementById('stu-list').innerHTML = list.map((s,i)=>`
      <tr>
        <td>${i+1}</td>
        <td><img src="${s.photo||'https://via.placeholder.com/50x60'}" class="student-photo"></td>
        <td>${s.name}</td>
        <td>${s.gender||''}</td>
        <td>${s.dob||''}</td>
        <td>${s.parent||''}</td>
        <td>${s.phone||''}</td>
        <td>${classes.find(c=>c.id===s.classId)?.name||''}</td>
        <td></td>
      </tr>
    `).join('');
  }

  // Load Attendance
  window.loadAttendance = function(){
    const cls = document.getElementById('att-class').value;
    const date = document.getElementById('att-date').value;
    const list = students.filter(s=>s.classId===cls);
    document.getElementById('att-list').innerHTML = list.map((s,i)=>`
      <tr>
        <td>${i+1}</td>
        <td><img src="${s.photo||'https://via.placeholder.com/50x60'}" class="student-photo"></td>
        <td>${s.name}</td>
        <td>
          <select id="st-${s.id}" class="border">
            <option value="present">á˜á€</option>
            <option value="permission">á…áŸ’á”á¶á”áŸ‹</option>
            <option value="absent">á¢áœááŸ’áá˜á¶á“</option>
          </select>
        </td>
        <td><input id="note-${s.id}" class="border"></td>
      </tr>
    `).join('');
  }

  // Save Attendance
  window.saveAttendance = async function(){
    const cls = document.getElementById('att-class').value;
    const date = document.getElementById('att-date').value;
    if(!cls || !date) return alert('áŸá¼á˜á‡áŸ’ášá¾áŸááŸ’á“á¶á€áŸ‹ á“á·á„ááŸ’á„áŸƒ');
    const records={};
    students.filter(s=>s.classId===cls).forEach(s=>{
      records[s.id]={
        status:document.getElementById('st-'+s.id).value,
        note:document.getElementById('note-'+s.id).value
      }
    });
    await setDoc(doc(db,'users',userId,'attendance',date+'_'+cls),{classId:cls,date,records});
    alert('ášá€áŸ’áŸá¶á‘á»á€ášá½á…ášá¶á›áŸ‹');
  }
</script>
</body>
</html>
